#include "drivers/ssd1306.h"
#include "display.h"
#include "stddef.h"
#include "platform.h"
#include "fonts.h"

const unsigned char background_heat [] = {
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0xF8, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x1F, 0x80, 0x00, 0x01, 0xF8, 0x00, 0x00, 0x0F, 0xC0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x7F, 0xC0, 0x00, 0x03, 0xFE, 0x00, 0x00, 0x1F, 0xF0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0xFF, 0xE0, 0x00, 0x0F, 0xFF, 0x00, 0x00, 0x7F, 0xF8, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x01, 0xFF, 0xF0, 0x00, 0x1F, 0xFF, 0x80, 0x00, 0xFF, 0xFC, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x07, 0xFF, 0xFC, 0x00, 0x3F, 0xFF, 0xE0, 0x01, 0xFF, 0xFF, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFE, 0x00, 0x7F, 0xFF, 0xF0, 0x07, 0xFF, 0xFF, 0x80, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x1F, 0xFF, 0xFF, 0x01, 0xFF, 0xFF, 0xF8, 0x0F, 0xFF, 0xFF, 0xC0, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xC3, 0xFF, 0xFF, 0xFC, 0x1F, 0xFF, 0xFF, 0xE0, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x01, 0xFF, 0x80, 0x00, 0x1F, 0xFC, 0x00, 0x00, 0x7F, 0xC0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x01, 0xFF, 0x80, 0x00, 0x0F, 0xFC, 0x00, 0x00, 0x7F, 0xC0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x01, 0xFF, 0x80, 0x00, 0x0F, 0xF8, 0x00, 0x00, 0xFF, 0xC0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x03, 0xFF, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x00, 0xFF, 0xC0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x03, 0xFF, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x00, 0xFF, 0xC0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x07, 0xFF, 0x00, 0x00, 0x3F, 0xF8, 0x00, 0x03, 0xFF, 0x80, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x0F, 0xFE, 0x00, 0x00, 0xFF, 0xF0, 0x00, 0x07, 0xFF, 0x80, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x1F, 0xFC, 0x00, 0x00, 0xFF, 0xE0, 0x00, 0x07, 0xFF, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x3F, 0xF8, 0x00, 0x01, 0xFF, 0xC0, 0x00, 0x0F, 0xFC, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x3F, 0xF0, 0x00, 0x01, 0xFF, 0x80, 0x00, 0x0F, 0xF8, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x3F, 0xF0, 0x00, 0x01, 0xFF, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x3F, 0xE0, 0x00, 0x03, 0xFF, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x3F, 0xE0, 0x00, 0x01, 0xFF, 0x00, 0x00, 0x0F, 0xF8, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x3F, 0xF0, 0x00, 0x03, 0xFF, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x3F, 0xF0, 0x00, 0x01, 0xFF, 0x80, 0x00, 0x0F, 0xFC, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x01, 0xFF, 0xC0, 0x00, 0x07, 0xFE, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x1F, 0xFC, 0x00, 0x00, 0xFF, 0xE0, 0x00, 0x07, 0xFF, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x0F, 0xFE, 0x00, 0x00, 0x7F, 0xF0, 0x00, 0x03, 0xFF, 0x80, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x03, 0xFE, 0x08, 0x80, 0x3F, 0xF0, 0x08, 0x21, 0xFF, 0x80, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xE3, 0xFF, 0x1F, 0xFF, 0x1F, 0xF8, 0xFF, 0xF8, 0xFF, 0xCF, 0xF0, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xF1, 0xFF, 0x1F, 0xFF, 0x0F, 0xF8, 0xFF, 0xF8, 0xFF, 0xC7, 0xF0, 0x00, 0x00,
		0x00, 0x00, 0x03, 0xE1, 0xFF, 0x8F, 0xFF, 0x9F, 0xF8, 0xFF, 0xF8, 0xFF, 0xC7, 0xFC, 0x00, 0x00,
		0x00, 0x00, 0x07, 0xE1, 0xFF, 0x00, 0x00, 0x0F, 0xF8, 0x00, 0x00, 0x7F, 0xC0, 0x7E, 0x00, 0x00,
		0x00, 0x00, 0x0F, 0xC1, 0xFF, 0x80, 0x00, 0x1F, 0xF8, 0x00, 0x00, 0x7F, 0xC0, 0x7E, 0x00, 0x00,
		0x00, 0x00, 0x0F, 0xC1, 0xFF, 0x00, 0x00, 0x0F, 0xF8, 0x00, 0x00, 0xFF, 0xC0, 0x3F, 0x00, 0x00,
		0x00, 0x00, 0x1F, 0x80, 0x11, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x02, 0x80, 0x1F, 0x80, 0x00,
		0x00, 0x00, 0x3F, 0x84, 0x88, 0x42, 0x08, 0x10, 0x02, 0x08, 0x28, 0x80, 0x00, 0x1F, 0xC0, 0x00,
		0x00, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x00,
		0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x00,
		0x00, 0x01, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
		};


static Display* displays_to_redraw[DISPLAY_REDRAW_MAX] = {};

void TIM2_IRQHandler() {
	//if (TIM_GetITStatus(TIM2, TIM_IT_Update) != RESET) {
	//	TIM_ClearITPendingBit(TIM2, TIM_IT_Update);
	//	for (unsigned int i=0; i<DISPLAY_REDRAW_MAX; i++) {
	//		if ( displays_to_redraw[i] != NULL ){
				//TH74HC595_Draw(displays_to_redraw[i]->instance);
	//		}
	//	}
	//}
}

int Display_Init(Display* display) {
	SSD1306_Init();
	SSD1306_Fill(SSD1306_COLOR_BLACK);
	SSD1306_drawBitmap(0,0, background_heat, 128, 68, SSD1306_COLOR_WHITE);
	SSD1306_UpdateScreen();
	delay_nms(500);
	SSD1306_Fill(SSD1306_COLOR_BLACK);
	SSD1306_UpdateScreen();
	return 0;
}


int Display_DrawTemp(Display* display, int temp) {
	char str[128] ={0};
	itoa(temp, str, 10);

	FONTS_SIZE_t size;
	FONTS_GetStringSize(str, &size, &Font_16x26);
	SSD1306_GotoXY(128-size.Length-8,0);
	SSD1306_Puts(str, &Font_16x26, SSD1306_COLOR_WHITE);
	return 0;
}

int Display_DrawMessage(Display* display, uint8_t height_from, char* msg) {
	FONTS_SIZE_t size;
	FONTS_GetStringSize(msg, &size, &Font_7x10);

	SSD1306_GotoXY(0, height_from-size.Height-5);
	SSD1306_Puts(msg, &Font_7x10, SSD1306_COLOR_WHITE);
	return 0;
}



int Display_WriteNumber(Display* display, int digits, uint8_t dots) {
	//TH74HC595_SetNumber(display->instance, digits, dots);
	return 0;
}

int Display_Write(Display* display, char chars[4]) {
	//TH74HC595_SetValue(display->instance, chars);
	return 0;
}
